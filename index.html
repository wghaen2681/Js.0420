<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./index.css">
</head>

<body>
  <div id="game" style="position: relative;">
    <div id="frame1">
      <div id="init-bg">
        <div id="btn-start">開始遊戲</div>
      </div>
    </div>
    <audio controls loop hidden id="audio1">
      <source src="IT.mp3"> 
    </audio>
  </div>

  <script src="./jquery-3.6.0.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js' integrity='sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==' crossorigin='anonymous'></script>
  <script src="./sweetalert2.all.min.js"></script>
  <script>
    $('#btn-start').click(() => {
      $('#init-bg').addClass('animation')

      $('#btn-start').hide()
      $('#btn-start').css({
        'user-select': 'none',
        '-webkit-user-drag': 'none',
        'pointer-events': 'none'
      })

      const str = 
      "世宏的妹妹被女鬼附身了，\n"
      + "女鬼把妹妹帶到陰宅，\n"
      + "並將妹妹混雜在多個被附身的受害者中，\n"
      + "世宏從阿嬤那邊得到一隻神明保佑的蠟燭，\n"
      + "試圖在受害者中要找出真正的女鬼，\n"
      + "把妹妹從陰宅救出來，\n"
      + "快協助阿明找出真正的女鬼在哪，\n"
      + "過程中女鬼會試圖滲透小明的意識，\n"
      + "玩家可以透過意象找出女鬼!"

      // 觸發 sweetalert 提示視窗
      Swal.fire({
        icon: 'warning',
        title: '遊戲規則',
        html: '<pre>' + str + '</pre>',
        confirmButtonText: '我暸解了!',
        customClass: {
          popup: 'format-pre'
        }
      }).then(()=> {
        // 加上 frame2 
        $('#game').append(`
        <div id="frame2"></div>
        `)
        // 設定隨機指定卡片是贏家 
        let rand = Math.round(Math.random()*15)
        let winX = rand % 5
        let winY = Math.floor(rand / 5)
        console.log('贏家卡片位在', '第', rand, ',x:', winX, ',y:', winY) 

        // 產生 15 張卡片（於開始動畫播放完畢後顯示） 
        for (let i = 0; i < 15; i++) {
          $('#frame2').append(`
          <div class="card" data-card=${i}>
          <div class="card-back"></div>
          <div class="card-front" ></div>
          </div>
          `)
          // 為指定卡片加上贏家標籤 
          if (i == rand) { 
            $('.card-front').eq(i).addClass('winner')
          }
        }
        // 加上蠟燭動圖 
        $('#game').append(`
          <img src="./img/mid_game_img/1.gif" alt="candle" id="candle">
        `)

        const audio = document.getElementById('audio1')
        const timer = setInterval(() => {
          audio.play().then(() => {
            clearInterval(timer)
          }).catch(() => {
          })
        }, 100)

        // 設定點擊卡片的程式碼 
        $('#frame2').on('click', '.card', function () {
          
          // 判斷點擊的卡片是否為贏家 
          // console.log($(this).children( ".card-front" ))
          // console.log($(this).children( ".card-front").attr("class"))

          // 如果點擊的是贏家卡片 
          if ($(this).children( ".card-front" ).hasClass('winner')) { 
            console.log('winner') 
            $('#game').append(`
              <div id="frame_end" class="clown_dance">
                <span> You Win!!</span>
                <button>再玩一次</button>
              </div>
            `)

            // 當使用者點擊再玩一次
            $('#frame_end').on('click', 'button', function () {
              window.location.reload("./")
            })
          // 如果點擊的不是贏家卡片 
          } else { 
            // 為卡片加上翻牌動畫 
            $(this).find('.card-front').addClass('card-open')
            
            // 尋找卡片索引值 
            // console.log($(this).attr('data-card')) 

            // 透過卡片索引值計算對應位置 
            const posX = $(this).attr('data-card') % 5
            const posY = Math.floor($(this).attr('data-card') / 5)
            // console.log(posX, posY) 

            // 計算卡片位置與贏家卡片位置差距值 
            const del = Math.sqrt((posX - winX)**2) + Math.sqrt((posY - winY)**2)
            console.log(del)

            // 針對差距值做動畫分級 
            if (del >= 5) { 
              console.log('you lose') 
              $('#frame2').remove()
              $('#candle').remove() 

              $('#game').append(`
              <div id="frame_end">
                <video controls autoplay muted width="100%" height="100%">
                  <source src="YOU DIED (HD).mp4">
                </video>
              </div>     
              `)
            } else if (del === 4) { 
              console.log('gonna lose 3') 
              $('#game').append('<div id="frame_end" class="scream"><p>準備迎接你的死期吧！</p></div>')

              setTimeout(() => {
                $('#frame_end').remove()
              }, 1000);
            } else if (del === 3) { 
              console.log('gonna lose 2') 
              $('#game').append('<div id="frame_end" class="clown"><p>我快抓到你囉！</p></div>')

              setTimeout(() => {
                $('#frame_end').remove()
              }, 1000);
            } else if (del === 2) { 
              console.log('gonna lose 1') 
              $('#game').append('<div id="frame_end" class="door"><p>我一步一步慢慢逼近...</p></div>')

              setTimeout(() => {
                $('#frame_end').remove()
              }, 1000);
            } else if (del <= 0) { 
              console.log('you win') 
              $('#game').append('<div class="frame_end clown_dance"></div>')
            }
          }
          
          // 指定卡片於翻牌一秒後恢復原狀 
          setTimeout(() => {
            $('.card-open').removeClass('card-open')
          }, 1000);
        })
      })
    }) 
  </script>
</body>

</html>
